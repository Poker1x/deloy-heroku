{"version":3,"file":"vercel-node-server.esm.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  NowRequestCookies,\n  NowRequestQuery,\n  NowRequestBody,\n  NowRequest,\n  NowResponse,\n} from '@vercel/node';\nimport { IncomingMessage, ServerResponse, Server, RequestListener } from 'http';\nimport micro, { buffer, send } from 'micro';\n// @ts-expect-error\nimport cloneResponse from 'clone-response';\n\nexport class ApiError extends Error {\n  readonly statusCode: number;\n\n  constructor(statusCode: number, message: string) {\n    super(message);\n    this.statusCode = statusCode;\n  }\n}\n\nfunction getBodyParser(req: NowRequest, body: Buffer | string) {\n  return function parseBody(): NowRequestBody {\n    if (!req.headers['content-type']) {\n      return undefined;\n    }\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { parse: parseContentType } = require('content-type');\n    const { type } = parseContentType(req.headers['content-type']);\n\n    if (type === 'application/json') {\n      try {\n        const str = body.toString();\n        return str ? JSON.parse(str) : {};\n      } catch (error) {\n        throw new ApiError(400, 'Invalid JSON');\n      }\n    }\n\n    if (type === 'application/octet-stream') {\n      return body;\n    }\n\n    if (type === 'application/x-www-form-urlencoded') {\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      const { parse: parseQS } = require('querystring');\n      // note: querystring.parse does not produce an iterable object\n      // https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options\n      return parseQS(body.toString());\n    }\n\n    if (type === 'text/plain') {\n      return body.toString();\n    }\n\n    return undefined;\n  };\n}\n\nfunction getQueryParser({ url = '/' }: NowRequest) {\n  return function parseQuery(): NowRequestQuery {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { parse: parseURL } = require('url');\n    return parseURL(url, true).query;\n  };\n}\n\nfunction getCookieParser(req: NowRequest) {\n  return function parseCookie(): NowRequestCookies {\n    const header: undefined | string | string[] = req.headers.cookie;\n\n    if (!header) {\n      return {};\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { parse } = require('cookie');\n    return parse(Array.isArray(header) ? header.join(';') : header);\n  };\n}\n\nfunction setLazyProp<T>(req: NowRequest, prop: string, getter: () => T) {\n  const opts = { configurable: true, enumerable: true };\n  const optsReset = { ...opts, writable: true };\n\n  Object.defineProperty(req, prop, {\n    ...opts,\n    get: () => {\n      const value = getter();\n      // we set the property on the object to avoid recalculating it\n      Object.defineProperty(req, prop, { ...optsReset, value });\n      return value;\n    },\n    set: value => {\n      Object.defineProperty(req, prop, { ...optsReset, value });\n    },\n  });\n}\n\nexport const enhanceRequest = async (req: NowRequest): Promise<NowRequest> => {\n  // We clone the request, so that we can read the incoming stream but then\n  // still allow subsequent consumers to do the same\n  const reqClone = cloneResponse(req);\n  const newReq = cloneResponse(req);\n  const body = await buffer(reqClone);\n\n  setLazyProp<NowRequestCookies>(newReq, 'cookies', getCookieParser(newReq));\n  setLazyProp<NowRequestQuery>(newReq, 'query', getQueryParser(newReq));\n  if (body != null) {\n    setLazyProp<NowRequestBody>(newReq, 'body', getBodyParser(newReq, body));\n  }\n\n  return newReq;\n};\n\nexport const enhanceResponse = (res: ServerResponse): NowResponse => {\n  let _status: number;\n  const nowRes = Object.assign(res, {\n    status: (status: number) => {\n      _status = status;\n      return nowRes;\n    },\n    json: (jsonBody: any) => {\n      send(nowRes, _status || 200, jsonBody);\n      return nowRes;\n    },\n    send: (body: string | object | Buffer) => {\n      send(nowRes, _status || 200, body);\n      return nowRes;\n    },\n    text: (body: string) => {\n      send(nowRes, _status || 200, body);\n      return nowRes;\n    },\n  });\n  return nowRes;\n};\n\nexport interface Config {\n  disableHelpers?: boolean;\n}\n\ninterface DefaultConfig {\n  disableHelpers: false;\n}\n\ntype NowRoute = (req: NowRequest, res: NowResponse) => void;\n\nexport const createServer = <C extends Config = DefaultConfig>(\n  route: C extends undefined\n    ? NowRoute\n    : C['disableHelpers'] extends true\n    ? RequestListener\n    : NowRoute,\n  config?: C\n) => {\n  if (config != null && config.disableHelpers) {\n    // @ts-expect-error\n    return new Server(route);\n  } else {\n    return micro(async (req: IncomingMessage, res: ServerResponse) => {\n      // @ts-expect-error\n      const nowReq = await enhanceRequest(req);\n      const nowRes = enhanceResponse(res);\n      return await route(nowReq, nowRes);\n    });\n  }\n};\n"],"names":["ApiError","statusCode","message","Error","getBodyParser","req","body","parseBody","headers","undefined","require","parseContentType","parse","type","str","toString","JSON","error","parseQS","getQueryParser","url","parseQuery","parseURL","query","getCookieParser","parseCookie","header","cookie","Array","isArray","join","setLazyProp","prop","getter","opts","configurable","enumerable","optsReset","writable","Object","defineProperty","get","value","set","enhanceRequest","reqClone","cloneResponse","newReq","buffer","enhanceResponse","res","_status","nowRes","assign","status","json","jsonBody","send","text","createServer","route","config","disableHelpers","Server","micro","nowReq"],"mappings":"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"}